<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1,minimal-ui" name="viewport">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
    <meta content="IE=Edge" http-equiv="X-UA-Compatible">
    <title>Root</title>
    <link rel="icon" type="image/png">
    <style>
        body: {
            max-width: 600px;
        }
        a:link { text-decoration: none; }
        a:visited { text-decoration: none; } 

        .root {
            position: relative;
            width: 100%;
        }
        .root .start, .end {
            text-align: center;
            border: 1px solid #aaa;
            border-radius: 8px;
            box-shadow: 5px 5px 5px #888;
            margin-bottom: 10px;
        }
        .root .day {
            min-height: 120px;
            border: 1px solid #aaa;
            border-radius: 8px;
            box-shadow: 5px 5px 5px #888;
            background:#fff;
            margin-bottom: 10px;
        }
        .root .day .title {
            padding: 5px;
        }
        .root .day .path {
            position:relative;
            width: 98%;
            white-space:nowrap;
            text-align:center;
            border: 1px solid #aaa;
            border-radius: 8px;
            box-shadow: 5px 5px 5px #888;
            background: #ccc;
            padding-top: 5px;
            padding-bottom: 8px;
            margin:auto;
            height:28px;
            margin-bottom: 10px;
        }
        .root .day .path > .dayContents {
            position:absolute;
            top: 5px;
            left: 10px;
        }
        .root .day .path > .dayBtns {
            position:absolute;
            top: 5px;
            right: 10px;
        }
        .root .dayPath {
            text-align: center;
            margin-bottom: 10px;
            color:#000;
            border: 1px solid #aaa;
            border-radius: 8px;
            box-shadow: 5px 5px 5px #888;
            background:#aaa;
            margin-left:5%;
            margin-right:5%;
        }
        .root .dragover {
            background:#ccccff;
        }
        .root .selected {
            background:#000;
            color:#fff;
        }
        .btns {
            width: 100%;
            text-align: right;
            padding: 10px;
        }
        .buttonType {
            border:1px solid #aaa;
            border-radius: 8px;
            box-shadow: 5px 5px 5px #888;
            background:#ccc;
            padding: 5px;
            margin-right:2px;
            font-size:12px;
        }
    </style>
    <script type="text/javascript" src="./../js/lib/jquery-2.2.4.js"></script>
    <script>
    
        var tempalteDayRoot = "";
        var tempalteDayPath = "";
        var templateDayRootStep = "";
        var tempalteDayStepPath = "";
        
        var dragStartDay = -1;
        var dragNowDay = -1;
        var dragStartX = 0;
        var dragStartY = 0;
        var positionX = 0;
        var positionY = 0;
        
        var travelStartDate = "20200120";
        
		function initDragRoot() {
			if(navigator.platform){
				if(navigator.userAgent.toLowerCase().indexOf("mobile") != -1){
					initDragRootMobile();
				} else {
					initDragRootPc();
				}
			}

		}
        
		function initDragRootPc() {
            
			$("[data-day]").off("dragstart").off("dragover").off("dragleave").off("drop");
			
            $("[data-day]").attr("draggable", "true");
            
            $("[data-day]").on("dragstart", function(e){
                dragStartDay = $(this).attr("data-day");
                $(this).addClass("selected");
            }).on("dragover", function(e){
                $("[data-day]").removeClass("dragover");
                if ($(this).attr("data-day") != dragStartDay){
                    $(this).addClass("dragover");
                }
                e.preventDefault();
            }).on("dragleave", function(){
                $("[data-day]").removeClass("selected");
                $("[data-day]").removeClass("dragover");
            }).on("drop", function(e){
                $("[data-day]").removeClass("dragover");
                $("[data-day='" +dragStartDay + "']").removeClass("selected");
                if ($(e.currentTarget).attr("data-day") != undefined && $(e.currentTarget).attr("data-day") != dragStartDay) {
                    changeDays(dragStartDay, $(e.currentTarget).attr("data-day"));
                }
            });
		}
		
		function initDragRootMobile() {

			$("[data-day]").off("touchstart").off("touchend");
			$("#root").off("touchmove");
			
			$("[data-day]").on("touchstart", function(e){
                dragStartDay = $(e.target).attr("data-day");
                if (dragStartDay == undefined){
                	return;
                }
                var tempDiv = $(e.target).clone();
                $(tempDiv).attr("id","tempDiv");
                $("#root").append(tempDiv);
                
                positionX = $(e.target).offset().left;
                positionY = $(e.target).offset().top;
                
                $("#tempDiv").css("position", "absolute");
                $("#tempDiv").css("top", positionY);
                $("#tempDiv").css("left",  positionX);
                $("#tempDiv").css("background","rgba(0,0,0,0.5)");
                $("#tempDiv").css("z-index","999");
                $("#tempDiv").css("width",$(e.target).css("width"));
                $("#tempDiv").removeAttr("data-day");
                dragStartX = e.originalEvent.touches[0].pageX;
                dragStartY = e.originalEvent.touches[0].pageY;
            }).on("touchend", function(e){
                $("[data-day]").removeClass("dragover");
                $("#tempDiv").remove();
                if (dragStartDay != undefined && dragNowDay != undefined && dragStartDay != -1 && dragNowDay != -1 && dragStartDay != dragNowDay) {
                	changeDays(dragStartDay, dragNowDay);
                }
            })
            $("#root").on("touchmove", function(e){
                e.preventDefault();
                if (dragStartDay == undefined){
                	return;
                }
                var depthX = e.originalEvent.touches[0].pageX - dragStartX;
                var depthY = e.originalEvent.touches[0].pageY - dragStartY;
                $("#tempDiv").css("left", positionX + depthX);
                $("#tempDiv").css("top", positionY + depthY);
                dragNowDay = -1;
                $.each($("[data-day]"), function(idx, valObj){
                	var offsetDiv = $(valObj).offset();
                	var x1 = offsetDiv.left;
                	var y1 = offsetDiv.top;
                	var x2 = x1 + parseInt($(valObj).css("width").replace("px",""));
                	var y2 = y1 + parseInt($(valObj).css("height").replace("px",""));
                	
                	if (x1 <= e.originalEvent.touches[0].pageX && x2 >= e.originalEvent.touches[0].pageX &&
                        y1 <= e.originalEvent.touches[0].pageY && y2 >= e.originalEvent.touches[0].pageY) {
                		dragNowDay = $(valObj).attr("data-day");
                		if (dragStartDay != dragNowDay) {
                			$(valObj).addClass("dragover");
                		}
                	} else {
                		$(valObj).removeClass("dragover");
                	}
                	
                });
            })
		}
		
		function changeDays(dayNum1, dayNum2) {
			var dayTemp1 = $("[data-day='" + dayNum1 + "']").clone(true);
            var dayTemp2 = $("[data-day='" + dayNum2 + "']").clone(true);
            var dayOrg1  = $("[data-day='" + dayNum1 + "']");
            var dayOrg2  = $("[data-day='" + dayNum2 + "']");
            
            $(dayTemp1).insertAfter($(dayOrg2));
            $(dayTemp2).insertAfter($(dayOrg1));

            // select는 clone() 버그로 개별 세팅해야함
            $.each($("select", $(dayTemp1)), function(idx, valObj){
                $(valObj).val($("select:eq(" + idx + ")", $(dayOrg1)).val());
            });
            $.each($("select", $(dayTemp2)), function(idx, valObj){
                $(valObj).val($("select:eq(" + idx + ")", $(dayOrg2)).val());
            });
            
            $(dayOrg1).remove();
            $(dayOrg2).remove();
            
            setDayItemsAll();
		}
		
		function getMaxDay() {
			var maxDay = 1;
			
			$.each($("[data-day]"), function(idx, valObj){
			    if (maxDay <= $(valObj).attr("data-day")) {
			    	maxDay = parseInt($(valObj).attr("data-day")) + 1;
			    }
			});
			
			return maxDay;
		}
		
		function addDayItem(){

			var maxDay = getMaxDay();
			var insertDay = -1;
			
			if ($("input[name='dayCheck']:checked").length == 1 && parseInt($("input[name='dayCheck']:checked").parent().parent().attr("data-day"))+1 != maxDay){
			    insertDay = parseInt($("input[name='dayCheck']:checked").parent().parent().attr("data-day")) + 1;
			    
			    $("#dayContents").append(tempalteDayRoot);
			    $("#dayContents [data-name='dayItem']:last").insertBefore($("[data-day='" + insertDay + "'"));
			    $("#dayContents").append(tempalteDayPath);
			    $("#dayContents [data-name='dayPath']:last").insertBefore($("[data-day='" + insertDay + "'"));
			} else if ($("input[name='dayCheck']:checked").length > 1){
				alert("Please Select Only 1 Day !!!!");
				return;
			} else {
	            insertDay = getMaxDay();

				if (insertDay > 1){
	                $("#dayContents").append(tempalteDayPath);
	                $("#dayContents [data-name='dayPath']:last").attr("data-daypath", (insertDay-1));
	            }
	            $("#dayContents").append(tempalteDayRoot);
	            $("#pathEnd").show();
			}

			setDayItemsAll();

			if (insertDay != -1){
                $("[data-day='" + insertDay + "']").append(templateDayRootStep);
			}
			
			initDragRoot();

		}
		
		function delDayItems() {
			if ($("input[name='dayCheck']:checked").length == 0){
				alert("Please Select 1 day for deleting");
				return;
			}
		    $.each($("input[name='dayCheck']:checked"), function(idx, valObj){
		    	var day = $(valObj).parent().parent().attr("data-day");
		    	$("[data-day='" + day + "']").remove();
                $("[data-daypath='" + day + "']").remove();
		    });
		    if ($("[data-day]")[0] == undefined) {
		    	$("#pathEnd").hide();
		    } else if ($("[data-day]").length == 1) {
		    	$("[data-daypath]").remove();
		    }
		    setDayItemsAll();
		}
		
		function chgDayItems(){
            if ($("input[name='dayCheck']:checked").length != 2){
                alert("Please Select 2 Days for changing each days");
                return;
            }
            changeDays($("input[name='dayCheck']:checked:eq(0)").parent().parent().attr("data-day"), $("input[name='dayCheck']:checked:eq(1)").parent().parent().attr("data-day"));
		}
		
		function setDayItemsAll() {
			var week = ["<font color='red'>일요일</font>", "월요일", "화요일", "수요일", "목요일", "금요일", "<font color='blue'>토요일</font>"];

			var tDate = new Date(parseInt(travelStartDate.substring(0,4)), parseInt(travelStartDate.substring(4,6))-1, parseInt(travelStartDate.substring(6,8)));
			$.each($("[data-name='dayItem']"), function(idx, valObj){
				$(valObj).attr("data-day", idx + 1);
				
				var titleHtml = "Day-" + (idx+1) + " (";
				titleHtml += tDate.getFullYear() + "/";
				titleHtml += (tDate.getMonth() + 1 < 10 ? ("0" + (tDate.getMonth() + 1)):("" + (tDate.getMonth() + 1))) + "/";
				titleHtml += (tDate.getDate() < 10 ? ("0" + tDate.getDate()):("" + tDate.getDate())) + " ";
				titleHtml += week[tDate.getDay()];
				titleHtml += ")";
				tDate.setDate(tDate.getDate() + 1);

				$("[data-name='title']", $(valObj)).html(titleHtml);
			});
			
		}
		
		function changeDayStep(day, stepNum1, stepNum2) {
            var dayTemp1 = $("[data-day='" + day + "'] [data-name='dayStep']:eq(" + stepNum1 + ")").clone(true);
            var dayTemp2 = $("[data-day='" + day + "'] [data-name='dayStep']:eq(" + stepNum2 + ")").clone(true);
            var dayOrg1  = $("[data-day='" + day + "'] [data-name='dayStep']:eq(" + stepNum1 + ")");
            var dayOrg2  = $("[data-day='" + day + "'] [data-name='dayStep']:eq(" + stepNum2 + ")");
            
            $(dayTemp1).insertAfter($(dayOrg2));
            $(dayTemp2).insertAfter($(dayOrg1));

            // select는 clone() 버그로 개별 세팅해야함
            $.each($("select", $(dayTemp1)), function(idx, valObj){
                $(valObj).val($("select:eq(" + idx + ")", $(dayOrg1)).val());
            });
            $.each($("select", $(dayTemp2)), function(idx, valObj){
                $(valObj).val($("select:eq(" + idx + ")", $(dayOrg2)).val());
            });
            
            $(dayOrg1).remove();
            $(dayOrg2).remove();
            
        }
		
		function upDayStep(obj){
			var day = $(obj).parent().parent().parent().attr("data-day");
			var idx = $("[data-day='" + day + "'] [data-name='dayStep']").index($(obj).parent().parent());
		
			if ($("[data-day='" + day + "'] [data-name='dayStep']").length == 1 || idx == 0){
                return;
            }
			
			changeDayStep(day, idx, idx-1);
		}
		
        function downDayStep(obj){
            var day = $(obj).parent().parent().parent().attr("data-day");
            var idx = $("[data-day='" + day + "'] [data-name='dayStep']").index($(obj).parent().parent());
        
            if ($("[data-day='" + day + "'] [data-name='dayStep']").length == 1 || $("[data-day='" + day + "'] [data-name='dayStep']").length == idx + 1){
                return;
            }
            changeDayStep(day, idx, idx+1);
        }
        
        function addDayStep(obj){
            var day = $(obj).parent().parent().parent().attr("data-day");
            
            $("[data-day='" + day + "']").append(tempalteDayStepPath);
            $("[data-day='" + day + "']").append(templateDayRootStep);
            $("[data-day='" + day + "'] [data-name='dayStep']:last").insertAfter($(obj).parent().parent());
            $("[data-day='" + day + "'] [data-name='dayStepPath']:last").insertAfter($(obj).parent().parent());
        }
        
        function subDayStep(obj){
        	var day = $(obj).parent().parent().parent().attr("data-day");
        	var idx = $("[data-day='" + day + "'] [data-name='dayStep']").index($(obj).parent().parent());
        	
        	if ($("[data-day='" + day + "'] [data-name='dayStep']").length == 1){
        		return;
        	}
        	
        	$("[data-day='" + day + "'] [data-name='dayStep']:eq(" + idx + ")").remove();
        	if ($("[data-day='" + day + "'] [data-name='dayStepPath']").length == idx) {
                $("[data-day='" + day + "'] [data-name='dayStepPath']:last").remove();
        	} else {
                $("[data-day='" + day + "'] [data-name='dayStepPath']:eq(" + idx + ")").remove();
        	}
        }
        
		function setButton(){
			$("#addBtn").bind("click", addDayItem);
			$("#delBtn").bind("click", delDayItems);
            $("#chgBtn").bind("click", chgDayItems);
		}
		
	    $(document).ready(function(){
	    	
            var pathHourHtml = "";
            var pathMinHtml = "";
            for (var i = 0; i < 60; i ++){
                var iStr = (i < 10) ? "0"+i:""+i;
                if (i < 24){
                    pathHourHtml += "<option value='" + iStr+ "'>" + iStr+ "</option>";
                }
                pathMinHtml += "<option value='" + iStr+ "'>" + iStr+ "</option>";
            }
            
            $("[data-name='pathHour']").append(pathHourHtml);
            $("[data-name='pathMin']").append(pathMinHtml);

	    	tempalteDayRoot = $("#tempalteDayRoot").html();
            templateDayRootStep = $("#templateDayRootStep").html();
            tempalteDayPath = $("#tempalteDayPath").html();
            tempalteDayStepPath = $("#tempalteDayStepPath").html();
            $("#tempalteDayRoot").remove();
            $("#templateDayRootStep").remove();
            $("#tempalteDayPath").remove();
            $("#tempalteDayStepPath").remove();            
            setButton();

	    });
	    
    </script>
</head>
<body>
    
    <div class="root" id="root">
    
        <div class="start">Start</div>
    
        <div class="dayPath" id="pathStart">▼</div>
    
        <div id="dayContents"></div>
        
        <div class="dayPath" id="pathEnd" style="display:none;">▼</div>

        <div class="end">End</div>
                    
    </div>
    
    <div class="btns">
        <a href="javascript:;" onclick="javascript:;" class="buttonType" id="chgBtn">바꾸기</a>
        <a href="javascript:;" onclick="javascript:;" class="buttonType" id="delBtn">삭제</a>
        <a href="javascript:;" onclick="javascript:;" class="buttonType" id="addBtn">추가</a>
    </div>
    
<div id="tempalteDayRoot" style="display:none;">
	<div class="day" data-name="dayItem">
        <span><input type="checkbox" name="dayCheck"></span><span class="title" data-name="title"></span><br>
	    
	</div>
</div>    

<div id="templateDayRootStep" style="display:none;">
	<div data-name="dayStep" class="path">
	   <div class="dayContents">
	       <select data-name="pathHour"></select> : <select data-name="pathMin"></select>
	       <select >
	          <option>지역</option>
	       </select>
	       <select >
	          <option>국가</option>
	       </select>
	       <select >
	          <option>도시</option>
	       </select>
	       <select >
	          <option>볼거리/먹거리</option>
	       </select>
	   </div>
	   <div class="dayBtns">
	       <a href="javascript:;" onclick="javascript:upDayStep(this);" class="buttonType">▲</a>
	       <a href="javascript:;" onclick="javascript:downDayStep(this);" class="buttonType">▼</a>
	       <a href="javascript:;" onclick="javascript:addDayStep(this);" class="buttonType">+</a>
	       <a href="javascript:;" onclick="javascript:subDayStep(this);" class="buttonType">-</a>
	   </div>
	</div>
</div>

<div id="tempalteDayPath" style="display:none;">
    <div class="dayPath" data-name="dayPath">
        <span style="display:none;">▼ By Car (298km / 9＄) ▼</span>
        <div style="width:100%;">
            ▼
            <select data-name="dayPathMoveBy">
                <option value="">이동방법</option>
                <option value="">페리</option>
                <option value="">비행기</option>
                <option value="">기차</option>
                <option value="">버스</option>
                <option value="">자동차</option>
                <option value="">도보</option>
                <option value="">기타</option>
                <option value="">이동없음</option>
            </select>
            <input type="text" data-name="dayPathMoveDist" style="width:60px;" placeHolder="거리">
            <select data-name="dayPathMoveDistGb">
                <option value="" selected>Km</option>
                <option value="">m</option>
            </select>
            <input type="text" data-name="dayPathMoveCost" style="width:60px;" placeHolder="예상비용">
            <select data-name="dayPathMoveDistCurrency" style="width:80px;">
                <option value="" selected>유로</option>
            </select>
            ▼
        </div>
    </div>
</div>

<div id="tempalteDayStepPath" style="display:none;">
    <div class="dayPath" data-name="dayStepPath">
        <span style="display:none;">▼ By Car (298km / 9＄) ▼</span>
        <div style="width:100%;">
            ▼
            <select data-name="dayPathMoveBy">
                <option value="">이동방법</option>
                <option value="">페리</option>
                <option value="">비행기</option>
                <option value="">기차</option>
                <option value="">버스</option>
                <option value="">자동차</option>
                <option value="">도보</option>
                <option value="">기타</option>
                <option value="">이동없음</option>
            </select>
            <input type="text" data-name="dayStepPathMoveDist" style="width:60px;" placeHolder="거리">
            <select data-name="dayStepPathMoveDistGb">
                <option value="" selected>Km</option>
                <option value="">m</option>
            </select>
            <input type="text" data-name="dayStepPathMoveCost" style="width:60px;" placeHolder="예상비용">
            <select data-name="dayStepPathMoveDistCurrency" style="width:80px;">
                <option value="" selected>유로</option>
            </select>
            ▼
        </div>
    </div>
</div>

</body>

</html>